<ng-container *ngIf="pageState$ | async as state">
  <main
    class="page page-fixed-scroll"
    *ngIf="state.status === 'ready'"
    [class.board-pattern-dots]="boardPatternDraft === 'dots'"
    [class.board-pattern-grid]="boardPatternDraft === 'grid'"
    [style.--board-widget-radius.px]="boardRadiusDraft"
    [style.--board-bg-color]="boardBackgroundColorDraft"
  >
    <div class="board-shell">
      <aside class="board-rail">
        <ng-container *ngIf="isWidgetEditMode; else boardView">
          <section class="board-header-stack board-meta-editor">
            <input type="text" name="board-name" class="inline-edit title" [(ngModel)]="boardDraftName" placeholder="Name" />
            <input type="text" name="board-headline" class="inline-edit subtitle" [(ngModel)]="boardDraftHeadline" placeholder="Description" />
          </section>
        </ng-container>
        <ng-template #boardView>
          <app-board-header [name]="state.board.name" [headline]="state.board.headline"></app-board-header>
        </ng-template>
      </aside>

      <section class="board-content widgets-section" *ngIf="widgets$ | async as widgets">
        <p class="error" *ngIf="widgetSaveError">{{ widgetSaveError }}</p>

        <div class="board-grid" *ngIf="isWidgetEditMode">
          <article
            *ngFor="let draft of widgetDrafts; let i = index"
            [class]="'board-tile board-card widget-tile widget-edit-tile ' + tileLayoutClass(draft.layout)"
            [class.widget-settings-open]="isWidgetSettingsOpen(draft)"
            (click)="openWidgetSettings(draft)"
          >
            <button
              type="button"
              class="widget-delete-button"
              (click)="deleteWidget(draft); $event.stopPropagation()"
              [disabled]="isWidgetSaving"
            >
              Delete
            </button>

            <ng-container *ngIf="isWidgetSettingsOpen(draft); else widgetPreview">
              <ng-container
                *ngTemplateOutlet="
                  widgetSettingsForm;
                  context: { $implicit: draft, isNew: false, index: i }
                "
              ></ng-container>
            </ng-container>

            <ng-template #widgetPreview>
              <div class="widget-edit-preview">
                <app-widget-host [widget]="widgetPreviewFromDraft(draft, i)" [previewMode]="true"></app-widget-host>
              </div>
            </ng-template>
          </article>

          <article
            [class]="'board-tile board-card board-card--compact widget-tile widget-edit-tile add-widget-tile ' + tileLayoutClass(newWidgetDraft.layout)"
            [class.board-card--scroll]="isAddWidgetExpanded"
            [class.add-widget-tile--collapsed]="!isAddWidgetExpanded"
          >
            <ng-container *ngIf="isAddWidgetExpanded; else addWidgetCollapsed">
              <ng-container
                *ngTemplateOutlet="
                  widgetSettingsForm;
                  context: { $implicit: newWidgetDraft, isNew: true, index: -1 }
                "
              ></ng-container>
            </ng-container>
            <ng-template #addWidgetCollapsed>
              <button type="button" (click)="openAddWidgetForm()" [disabled]="isWidgetSaving">Add Widget</button>
            </ng-template>
          </article>
        </div>

        <ng-container *ngIf="!isWidgetEditMode">
          <p class="widgets-empty text-muted" *ngIf="widgets.length === 0">No widgets configured yet.</p>
          <div class="board-grid" *ngIf="widgets.length > 0">
            <div
              class="board-tile widget-tile"
              *ngFor="let widget of widgets; let i = index; trackBy: trackWidget"
              [class]="'board-tile widget-tile ' + tileLayoutClass(widget.layout)"
            >
              <app-widget-host [widget]="widget"></app-widget-host>
            </div>
          </div>
        </ng-container>
      </section>
    </div>

    <div class="bottom-actions" *ngIf="widgets$ | async as widgets">
      <div class="bottom-actions-left">
        <button type="button" class="bottom-action-button orb-button orb-button--red" routerLink="/">
          <span class="orb-button__dot" aria-hidden="true"></span>
          <span class="orb-button__label">Home</span>
        </button>
        <button type="button" class="bottom-action-button orb-button orb-button--yellow">
          <span class="orb-button__dot" aria-hidden="true"></span>
          <span class="orb-button__label">Search</span>
        </button>
        <div class="account-menu-wrap">
          <button type="button" class="bottom-action-button orb-button orb-button--blue" (click)="toggleAccountMenu()">
            <span class="orb-button__dot" aria-hidden="true"></span>
            <span class="orb-button__label">{{ accountUser.username }}</span>
          </button>
          <div class="account-menu" *ngIf="isAccountMenuOpen">
            <ng-container *ngIf="isSignedIn; else signedOutMenu">
            <section class="account-user">
              <p class="account-user-name">{{ accountUser.name }}</p>
              <p class="account-user-handle text-muted">{{ isSignedIn ? accountUser.username : 'Sign In' }}</p>
            </section>
            <hr />
            <p class="account-menu-label meta-label">Boards</p>
            <a *ngFor="let board of accountBoards" [routerLink]="board.route" (click)="closeAccountMenu()">
              <span>{{ board.label }}</span>
              <span class="meta-label account-menu-item-tag" *ngIf="isMainBoard(board.id)">Main Board</span>
            </a>
            <button type="button" class="account-link" (click)="createNewBoard()" [disabled]="isCreatingBoard">{{ isCreatingBoard ? 'Creating... ' : 'Create a New Board' }}</button>
            <p class="account-menu-error" *ngIf="createBoardError">{{ createBoardError }}</p>
            <hr />
            <a class="account-link" routerLink="/insights" (click)="closeAccountMenu()">Insights</a>
            <a class="account-link" routerLink="/settings" (click)="closeAccountMenu()">Settings</a>
            <button type="button" class="account-link" (click)="signOut()" [disabled]="isSigningOut">{{ isSigningOut ? 'Signing Out...' : 'Sign Out' }}</button>
            </ng-container>
            <ng-template #signedOutMenu>
              <a class="account-link" routerLink="/signin" (click)="closeAccountMenu()">Sign In</a>
            </ng-template>
          </div>
        </div>
      </div>

      <div class="board-identity-wrap" *ngIf="!readOnlyView && canEditBoard">
        <div class="board-identity-menu-anchor">
          <button type="button" class="bottom-action-button board-identity-button bottom-action-pill" (click)="toggleBoardIdentityMenu()">
            {{ boardIdentityNameDraft || boardMenuLabel(state.board.id) }} (/{{ boardIdentitySlugDraft || state.board.boardUrl }})
          </button>
          <div class="board-identity-menu" *ngIf="isBoardIdentityMenuOpen">
            <label>
              Board Name
              <input type="text" name="board-identity-name" [(ngModel)]="boardIdentityNameDraft" />
            </label>
            <label>
              URL
              <div class="slug-input-wrap">
                <span>/</span>
                <input type="text" name="board-identity-slug" [(ngModel)]="boardIdentitySlugDraft" />
              </div>
            </label>
            <hr />
            <div class="board-appearance-row">
              <label>
                Widget Radius
                <input type="range" name="board-radius" min="1" max="3" step="1" [(ngModel)]="boardRadiusStepDraft" />
              </label>
              <label for="board-theme-toggle">
                <span>Theme</span>
                <input type="checkbox" id="board-theme-toggle" name="board-theme-toggle" [(ngModel)]="boardThemeToggleDraft" />
              </label>
            </div>
            <hr />
            <label>
              Background Color
              <div class="board-color-options">
                <button type="button" aria-label="Background color option 1"></button>
                <button type="button" aria-label="Background color option 2"></button>
                <button type="button" aria-label="Background color option 3"></button>
                <button type="button" aria-label="Background color option 4"></button>
                <button type="button" aria-label="Background color option 5"></button>
                <button type="button" aria-label="Background color option 6"></button>
                <button type="button" aria-label="Background color option 7"></button>
              </div>
            </label>
            <label>
              Pattern
              <div class="board-pattern-options">
                <button type="button" aria-label="Pattern option 1"></button>
                <button type="button" aria-label="Pattern option 2"></button>
                <button type="button" aria-label="Pattern option 3"></button>
                <button type="button" aria-label="Pattern option 4"></button>
                <button type="button" aria-label="Pattern option 5"></button>
                <button type="button" aria-label="Pattern option 6"></button>
                <button type="button" aria-label="Pattern option 7"></button>
              </div>
            </label>
          </div>
        </div>
          <button
            type="button"
            class="bottom-action-button orb-button orb-button--gray"
            *ngIf="!isWidgetEditMode; else doneButton"
            (click)="startWidgetEdit(state.board, widgets)"
          >
          <span class="orb-button__dot" aria-hidden="true"></span>
          <span class="orb-button__label">Edit</span>
        </button>
        <ng-template #doneButton>
          <button type="button" class="bottom-action-button orb-button orb-button--gray" (click)="doneWidgetEdit()" [disabled]="isWidgetSaving">
            <span class="orb-button__dot" aria-hidden="true"></span>
            <span class="orb-button__label">Done</span>
          </button>
        </ng-template>
      </div>
    </div>
  </main>
  <main class="page" *ngIf="state.status === 'loading'">
    <p>Loading...</p>
  </main>
  <main class="page" *ngIf="state.status === 'missing'">
    <p>Board not found.</p>
  </main>

  <div class="bottom-actions" *ngIf="state.status !== 'ready'">
    <div class="bottom-actions-left">
      <button type="button" class="bottom-action-button orb-button orb-button--red" routerLink="/">
        <span class="orb-button__dot" aria-hidden="true"></span>
        <span class="orb-button__label">Home</span>
      </button>
      <button type="button" class="bottom-action-button orb-button orb-button--yellow">
        <span class="orb-button__dot" aria-hidden="true"></span>
        <span class="orb-button__label">Search</span>
      </button>
      <div class="account-menu-wrap">
        <button type="button" class="bottom-action-button orb-button orb-button--blue" (click)="toggleAccountMenu()">
          <span class="orb-button__dot" aria-hidden="true"></span>
          <span class="orb-button__label">{{ accountUser.username }}</span>
        </button>
        <div class="account-menu" *ngIf="isAccountMenuOpen">
          <ng-container *ngIf="isSignedIn; else signedOutMenuFallback">
            <section class="account-user">
              <p class="account-user-name">{{ accountUser.name }}</p>
              <p class="account-user-handle text-muted">{{ accountUser.username }}</p>
            </section>
            <hr />
            <p class="account-menu-label meta-label">Boards</p>
            <a *ngFor="let board of accountBoards" [routerLink]="board.route" (click)="closeAccountMenu()">
              <span>{{ board.label }}</span>
              <span class="meta-label account-menu-item-tag" *ngIf="isMainBoard(board.id)">Main Board</span>
            </a>
            <button type="button" class="account-link" (click)="createNewBoard()" [disabled]="isCreatingBoard">{{ isCreatingBoard ? 'Creating... ' : 'Create a New Board' }}</button>
            <p class="account-menu-error" *ngIf="createBoardError">{{ createBoardError }}</p>
            <hr />
            <a class="account-link" routerLink="/insights" (click)="closeAccountMenu()">Insights</a>
            <a class="account-link" routerLink="/settings" (click)="closeAccountMenu()">Settings</a>
            <button type="button" class="account-link" (click)="signOut()" [disabled]="isSigningOut">{{ isSigningOut ? 'Signing Out...' : 'Sign Out' }}</button>
          </ng-container>
          <ng-template #signedOutMenuFallback>
            <a class="account-link" routerLink="/signin" (click)="closeAccountMenu()">Sign In</a>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<ng-template #widgetSettingsForm let-draft let-isNew="isNew" let-i="index">
  <div class="widget-settings-panel">
    <div class="widget-editor-head">
      <input
        type="text"
        class="widget-title-inline inline-edit"
        [name]="isNew ? 'new-widget-title' : 'widget-title-' + draft.id"
        [(ngModel)]="draft.title"
        (ngModelChange)="isNew ? onNewWidgetFieldChange() : onWidgetDraftFieldChange(draft)"
        placeholder="Widget Name"
      />
    </div>

    <label>
      Type
      <select
        [name]="isNew ? 'new-widget-type' : 'widget-type-' + draft.id"
        [(ngModel)]="draft.type"
        (ngModelChange)="isNew ? onNewWidgetTypeChange() : onWidgetTypeChange(draft)"
      >
        <option value="embed">Embed</option>
        <option value="link">Link</option>
        <option value="map">Map</option>
        <option value="user-settings">User Settings</option>
        <option value="admin-settings">Admin Settings</option>
        <option value="signin">Sign In</option>
        <option value="signup">Sign Up</option>
      </select>
    </label>
    <label>
      Layout
      <select
        [name]="isNew ? 'new-widget-layout' : 'widget-layout-' + draft.id"
        [(ngModel)]="draft.layout"
        (ngModelChange)="isNew ? onNewWidgetFieldChange() : onWidgetDraftFieldChange(draft)"
      >
        <option value="span-1">1c x 1r</option>
        <option value="span-2">2c x 1r</option>
        <option value="span-3">3c x 1r</option>
        <option value="span-4">4c x 1r</option>
        <option value="span-1x2">1c x 2r</option>
        <option value="span-2x2">2c x 2r</option>
        <option value="span-3x3">3c x 3r</option>
      </select>
    </label>
    <label *ngIf="draft.type === 'embed'">
      Embed URL
      <input
        type="text"
        [name]="isNew ? 'new-widget-embed-url' : 'widget-embed-url-' + draft.id"
        [(ngModel)]="draft.embedUrl"
        (ngModelChange)="isNew ? onNewWidgetFieldChange() : onWidgetDraftFieldChange(draft)"
      />
    </label>
    <label *ngIf="draft.type === 'link'">
      Link URL
      <input
        type="text"
        [name]="isNew ? 'new-widget-link-url' : 'widget-link-url-' + draft.id"
        [(ngModel)]="draft.linkUrl"
        (ngModelChange)="isNew ? onNewWidgetFieldChange() : onWidgetDraftFieldChange(draft)"
      />
    </label>
    <label *ngIf="draft.type === 'map'">
      Places (one per line)
      <textarea
        [name]="isNew ? 'new-widget-places' : 'widget-places-' + draft.id"
        [(ngModel)]="draft.placesText"
        (ngModelChange)="isNew ? onNewWidgetFieldChange() : onWidgetDraftFieldChange(draft)"
        rows="4"
      ></textarea>
    </label>
    <p class="field-error" *ngIf="!isNew && getDraftValidationError(draft) as error">{{ error }}</p>
    <p class="field-error" *ngIf="isNew && newWidgetValidationError">{{ newWidgetValidationError }}</p>
    <div class="widget-editor-actions" *ngIf="!isNew">
      <button type="button" (click)="moveWidget(draft, -1); $event.stopPropagation()" [disabled]="isWidgetSaving || i === 0">Up</button>
      <button type="button" (click)="moveWidget(draft, 1); $event.stopPropagation()" [disabled]="isWidgetSaving || i === widgetDrafts.length - 1">Down</button>
    </div>
    <div class="widget-editor-actions" *ngIf="isNew">
      <button type="button" (click)="addNewWidget()" [disabled]="isWidgetSaving">Add</button>
    </div>
  </div>
</ng-template>
