<ng-container *ngIf="pageState$ | async as state">
  <main class="page" *ngIf="state.status === 'ready'">
    <div class="board-shell">
      <aside class="board-rail">
        <ng-container *ngIf="isWidgetEditMode; else boardView">
          <section class="board-meta-editor">
            <label>
              Name
              <input type="text" name="board-name" [(ngModel)]="boardDraftName" />
            </label>
            <label>
              Headline
              <input type="text" name="board-headline" [(ngModel)]="boardDraftHeadline" />
            </label>
          </section>
        </ng-container>
        <ng-template #boardView>
          <app-board-header [name]="state.board.name" [headline]="state.board.headline"></app-board-header>
        </ng-template>
      </aside>

      <section class="board-content widgets-section" *ngIf="widgets$ | async as widgets">
        <p class="error" *ngIf="widgetSaveError">{{ widgetSaveError }}</p>

        <div class="board-grid" *ngIf="isWidgetEditMode">
          <article
            *ngFor="let draft of widgetDrafts; let i = index"
            [class]="'board-tile board-card board-card--compact board-card--scroll widget-tile widget-edit-tile ' + tileLayoutClass(draft.layout)"
          >
            <div class="widget-editor-head">
              <h3>{{ draft.title || 'Widget' }}</h3>
              <div class="widget-editor-actions">
                <button type="button" (click)="moveWidget(draft, -1)" [disabled]="isWidgetSaving || i === 0">Up</button>
                <button type="button" (click)="moveWidget(draft, 1)" [disabled]="isWidgetSaving || i === widgetDrafts.length - 1">Down</button>
              </div>
            </div>

            <label>
              Type
              <select [name]="'widget-type-' + (draft.id ?? 'new')" [(ngModel)]="draft.type" (ngModelChange)="onWidgetTypeChange(draft)">
                <option value="embed">Embed</option>
                <option value="link">Link</option>
                <option value="map">Map</option>
              </select>
            </label>
            <label>
              Title
              <input type="text" [name]="'widget-title-' + (draft.id ?? 'new')" [(ngModel)]="draft.title" (ngModelChange)="onWidgetDraftFieldChange(draft)" />
            </label>
            <label>
              Layout
              <select [name]="'widget-layout-' + (draft.id ?? 'new')" [(ngModel)]="draft.layout" (ngModelChange)="onWidgetDraftFieldChange(draft)">
                <option value="span-1">1c x 1r</option>
                <option value="span-2">2c x 1r</option>
                <option value="span-1x2">1c x 2r</option>
                <option value="span-2x2">2c x 2r</option>
              </select>
            </label>
            <label class="checkbox">
              <input type="checkbox" [name]="'widget-enabled-' + (draft.id ?? 'new')" [(ngModel)]="draft.enabled" (ngModelChange)="onWidgetDraftFieldChange(draft)" />
              Enabled
            </label>

            <label *ngIf="draft.type === 'embed'">
              Embed URL
              <input type="text" [name]="'widget-embed-url-' + (draft.id ?? 'new')" [(ngModel)]="draft.embedUrl" (ngModelChange)="onWidgetDraftFieldChange(draft)" />
            </label>
            <label *ngIf="draft.type === 'link'">
              Link URL
              <input type="text" [name]="'widget-link-url-' + (draft.id ?? 'new')" [(ngModel)]="draft.linkUrl" (ngModelChange)="onWidgetDraftFieldChange(draft)" />
            </label>
            <label *ngIf="draft.type === 'map'">
              Places (one per line)
              <textarea [name]="'widget-places-' + (draft.id ?? 'new')" [(ngModel)]="draft.placesText" (ngModelChange)="onWidgetDraftFieldChange(draft)" rows="4"></textarea>
            </label>
            <p class="field-error" *ngIf="getDraftValidationError(draft) as error">{{ error }}</p>

            <div class="widget-editor-actions">
              <button type="button" (click)="deleteWidget(draft)" [disabled]="isWidgetSaving">Delete</button>
            </div>
          </article>

          <article
            [class]="'board-tile board-card board-card--compact board-card--scroll widget-tile widget-edit-tile add-widget-tile ' + tileLayoutClass(newWidgetDraft.layout)"
          >
            <h3>Add widget</h3>
            <label>
              Type
              <select name="new-widget-type" [(ngModel)]="newWidgetDraft.type" (ngModelChange)="onNewWidgetTypeChange()">
                <option value="embed">Embed</option>
                <option value="link">Link</option>
                <option value="map">Map</option>
              </select>
            </label>
            <label>
              Title
              <input type="text" name="new-widget-title" [(ngModel)]="newWidgetDraft.title" (ngModelChange)="onNewWidgetFieldChange()" />
            </label>
            <label>
              Layout
              <select name="new-widget-layout" [(ngModel)]="newWidgetDraft.layout" (ngModelChange)="onNewWidgetFieldChange()">
                <option value="span-1">1c x 1r</option>
                <option value="span-2">2c x 1r</option>
                <option value="span-1x2">1c x 2r</option>
                <option value="span-2x2">2c x 2r</option>
              </select>
            </label>
            <label class="checkbox">
              <input type="checkbox" name="new-widget-enabled" [(ngModel)]="newWidgetDraft.enabled" (ngModelChange)="onNewWidgetFieldChange()" />
              Enabled
            </label>

            <label *ngIf="newWidgetDraft.type === 'embed'">
              Embed URL
              <input type="text" name="new-widget-embed-url" [(ngModel)]="newWidgetDraft.embedUrl" (ngModelChange)="onNewWidgetFieldChange()" />
            </label>
            <label *ngIf="newWidgetDraft.type === 'link'">
              Link URL
              <input type="text" name="new-widget-link-url" [(ngModel)]="newWidgetDraft.linkUrl" (ngModelChange)="onNewWidgetFieldChange()" />
            </label>
            <label *ngIf="newWidgetDraft.type === 'map'">
              Places (one per line)
              <textarea name="new-widget-places" [(ngModel)]="newWidgetDraft.placesText" (ngModelChange)="onNewWidgetFieldChange()" rows="4"></textarea>
            </label>
            <p class="field-error" *ngIf="newWidgetValidationError">{{ newWidgetValidationError }}</p>

            <div class="widget-editor-actions">
              <button type="button" (click)="addNewWidget()" [disabled]="isWidgetSaving">Add</button>
            </div>
          </article>
        </div>

        <ng-container *ngIf="!isWidgetEditMode">
          <p class="widgets-empty" *ngIf="widgets.length === 0">No widgets configured yet.</p>
          <div class="board-grid" *ngIf="widgets.length > 0">
            <div
              class="board-tile widget-tile"
              *ngFor="let widget of widgets; let i = index; trackBy: trackWidget"
              [class]="'board-tile widget-tile ' + tileLayoutClass(widget.layout)"
            >
              <app-widget-host [widget]="widget"></app-widget-host>
            </div>
          </div>
        </ng-container>
      </section>
    </div>

    <div class="bottom-actions" *ngIf="widgets$ | async as widgets">
      <button type="button" routerLink="/">Logo</button>
      <div class="account-menu-wrap">
        <button type="button" (click)="toggleAccountMenu()">Account</button>
        <div class="account-menu" *ngIf="isAccountMenuOpen">
          <p class="account-menu-label">Boards</p>
          <a *ngFor="let board of accountBoards" [routerLink]="board.route" (click)="closeAccountMenu()">{{ board.label }}</a>
          <button type="button" class="account-link">Create New Board</button>
          <hr />
          <a class="account-link" routerLink="/analytics" (click)="closeAccountMenu()">Analytics</a>
          <button type="button" class="account-link">Settings</button>
          <button type="button" class="account-link">Sign Out</button>
        </div>
      </div>
      <button
        type="button"
        *ngIf="!isWidgetEditMode && !isHomeBoard(state.board); else doneButton"
        (click)="startWidgetEdit(state.board, widgets)"
      >
        Edit
      </button>
      <ng-template #doneButton>
        <button type="button" *ngIf="!isHomeBoard(state.board)" (click)="doneWidgetEdit(state.board.id)" [disabled]="isWidgetSaving">Done</button>
      </ng-template>
    </div>
  </main>
  <main class="page" *ngIf="state.status === 'loading'">
    <p>Loading...</p>
  </main>
  <main class="page" *ngIf="state.status === 'missing'">
    <p>Board not found.</p>
  </main>
</ng-container>
