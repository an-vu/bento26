<ng-container *ngIf="pageState$ | async as state">
  <main class="page" *ngIf="state.status === 'ready'">
    <app-profile-header [name]="state.profile.name" [headline]="state.profile.headline"></app-profile-header>

    <section class="widgets-section" *ngIf="widgets$ | async as widgets">
      <div class="widget-editor" *ngIf="isWidgetEditMode">
        <p class="error" *ngIf="widgetSaveError">{{ widgetSaveError }}</p>

        <article class="widget-editor-card" *ngFor="let draft of widgetDrafts; let i = index">
          <div class="widget-editor-head">
            <h3>{{ draft.title || 'Widget' }}</h3>
            <div class="widget-editor-actions">
              <button type="button" (click)="moveWidget(state.profile.id, draft, -1)" [disabled]="isWidgetSaving || i === 0">Up</button>
              <button type="button" (click)="moveWidget(state.profile.id, draft, 1)" [disabled]="isWidgetSaving || i === widgetDrafts.length - 1">Down</button>
            </div>
          </div>

          <label>
            Type
            <select [name]="'widget-type-' + (draft.id ?? 'new')" [(ngModel)]="draft.type" (ngModelChange)="onWidgetTypeChange(draft)">
              <option value="embed">Embed</option>
              <option value="link">Link</option>
              <option value="map">Map</option>
            </select>
          </label>
          <label>
            Title
            <input type="text" [name]="'widget-title-' + (draft.id ?? 'new')" [(ngModel)]="draft.title" />
          </label>
          <label>
            Layout
            <input type="text" [name]="'widget-layout-' + (draft.id ?? 'new')" [(ngModel)]="draft.layout" />
          </label>
          <label>
            Order
            <input type="number" [name]="'widget-order-' + (draft.id ?? 'new')" [(ngModel)]="draft.order" min="0" disabled />
          </label>
          <label class="checkbox">
            <input type="checkbox" [name]="'widget-enabled-' + (draft.id ?? 'new')" [(ngModel)]="draft.enabled" />
            Enabled
          </label>

          <label *ngIf="draft.type === 'embed'">
            Embed URL
            <input type="text" [name]="'widget-embed-url-' + (draft.id ?? 'new')" [(ngModel)]="draft.embedUrl" />
          </label>
          <label *ngIf="draft.type === 'link'">
            Link URL
            <input type="text" [name]="'widget-link-url-' + (draft.id ?? 'new')" [(ngModel)]="draft.linkUrl" />
          </label>
          <label *ngIf="draft.type === 'map'">
            Places (one per line)
            <textarea [name]="'widget-places-' + (draft.id ?? 'new')" [(ngModel)]="draft.placesText" rows="4"></textarea>
          </label>

          <div class="widget-editor-actions">
            <button type="button" (click)="saveWidget(state.profile.id, draft)" [disabled]="isWidgetSaving">Save widget</button>
            <button type="button" (click)="deleteWidget(state.profile.id, draft)" [disabled]="isWidgetSaving">Delete</button>
          </div>
        </article>

        <article class="widget-editor-card">
          <h3>Add new widget</h3>
          <label>
            Type
            <select name="new-widget-type" [(ngModel)]="newWidgetDraft.type" (ngModelChange)="onNewWidgetTypeChange()">
              <option value="embed">Embed</option>
              <option value="link">Link</option>
              <option value="map">Map</option>
            </select>
          </label>
          <label>
            Title
            <input type="text" name="new-widget-title" [(ngModel)]="newWidgetDraft.title" />
          </label>
          <label>
            Layout
            <input type="text" name="new-widget-layout" [(ngModel)]="newWidgetDraft.layout" />
          </label>
          <label>
            Order
            <input type="number" name="new-widget-order" [(ngModel)]="newWidgetDraft.order" min="0" />
          </label>
          <label class="checkbox">
            <input type="checkbox" name="new-widget-enabled" [(ngModel)]="newWidgetDraft.enabled" />
            Enabled
          </label>

          <label *ngIf="newWidgetDraft.type === 'embed'">
            Embed URL
            <input type="text" name="new-widget-embed-url" [(ngModel)]="newWidgetDraft.embedUrl" />
          </label>
          <label *ngIf="newWidgetDraft.type === 'link'">
            Link URL
            <input type="text" name="new-widget-link-url" [(ngModel)]="newWidgetDraft.linkUrl" />
          </label>
          <label *ngIf="newWidgetDraft.type === 'map'">
            Places (one per line)
            <textarea name="new-widget-places" [(ngModel)]="newWidgetDraft.placesText" rows="4"></textarea>
          </label>

          <div class="widget-editor-actions">
            <button type="button" (click)="addNewWidget(state.profile.id)" [disabled]="isWidgetSaving">Add widget</button>
          </div>
        </article>

      </div>

      <ng-container *ngIf="!isWidgetEditMode">
        <p class="widgets-empty" *ngIf="widgets.length === 0">No widgets configured yet.</p>
        <div class="widgets-grid" *ngIf="widgets.length > 0" [class.is-dragging]="draggingTileIndex !== null">
          <div
            class="widget-tile"
            *ngFor="let widget of widgets; let i = index; trackBy: trackWidget"
            [class.is-dragging]="draggingTileIndex === i"
            draggable="true"
            (dragstart)="onWidgetTileDragStart($event, i)"
            (dragover)="onWidgetTileDragOver($event)"
            (drop)="onWidgetTileDrop(state.profile.id, widgets, i)"
            (dragend)="onWidgetTileDragEnd()"
          >
            <app-widget-host [widget]="widget"></app-widget-host>
          </div>
        </div>
      </ng-container>
    </section>

    <div class="bottom-actions" *ngIf="widgets$ | async as widgets">
      <button type="button">Logo</button>
      <button type="button">Account</button>
      <button
        type="button"
        *ngIf="!isWidgetEditMode; else doneButton"
        (click)="startWidgetEdit(widgets)"
      >
        Edit
      </button>
      <ng-template #doneButton>
        <button type="button" (click)="cancelWidgetEdit()">Done</button>
      </ng-template>
    </div>
  </main>
  <main class="page" *ngIf="state.status === 'loading'">
    <p>Loading...</p>
  </main>
  <main class="page" *ngIf="state.status === 'missing'">
    <p>Profile not found.</p>
  </main>
</ng-container>
